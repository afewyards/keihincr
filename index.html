<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keihin CR26 Carburetor Tuning</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .controls-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 25px;
            background: #f7fafc;
            border-radius: 12px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .control-group select {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-group select:hover {
            border-color: #667eea;
        }

        .control-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .data-table {
            margin-bottom: 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        th {
            background: #2d3748;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: #f7fafc;
        }

        .percentage {
            color: #667eea;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            background: white;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            margin-bottom: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .chart-container canvas {
            min-width: 600px;
            min-height: 600px;
        }

        .button-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        button {
            flex: 1;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.9em;
        }

        .legend-line {
            width: 30px;
            height: 3px;
            margin-right: 10px;
            border-radius: 2px;
        }

        .legend-band {
            width: 30px;
            height: 16px;
            margin-right: 10px;
            border-radius: 3px;
            opacity: 0.3;
        }


        .config-section {
            margin-bottom: 20px;
        }

        .config-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 8px 8px 0 0;
            color: white;
        }

        .current-title {
            background: rgb(59, 130, 246);
        }

        .correction-title {
            background: rgb(34, 197, 94);
        }

        .config-section .controls-row {
            border-radius: 0 0 12px 12px;
        }

        .config-section:first-of-type .controls-row {
            border: 2px solid rgb(59, 130, 246);
        }

        .correction-row {
            border: 2px solid rgb(34, 197, 94);
        }


        /* Rotary Dial Styles */
        .dial-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .dial-group label {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .dial-container {
            width: 60px;
            height: 60px;
            position: relative;
            user-select: none;
        }

        .dial-knob {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(145deg, #e6e6e6, #ffffff);
            box-shadow: 4px 4px 10px #d1d1d1, -4px -4px 10px #ffffff, inset 1px 1px 2px rgba(255,255,255,0.8);
            cursor: grab;
            position: relative;
            transition: box-shadow 0.1s;
        }

        .dial-knob:active {
            cursor: grabbing;
            box-shadow: 2px 2px 6px #d1d1d1, -2px -2px 6px #ffffff, inset 2px 2px 4px rgba(0,0,0,0.1);
        }

        .dial-knob::before {
            content: '';
            position: absolute;
            top: 6px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 12px;
            background: #2d3748;
            border-radius: 2px;
        }

        .dial-knob.current::before {
            background: rgb(59, 130, 246);
        }

        .dial-knob.correction::before {
            background: rgb(34, 197, 94);
        }

        .dial-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75em;
            font-weight: 600;
            color: #4a5568;
            white-space: nowrap;
            pointer-events: none;
        }

        .dial-ticks {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .dial-tick {
            position: absolute;
            width: 2px;
            height: 5px;
            background: #a0aec0;
            left: 50%;
            top: 1px;
            transform-origin: 50% 29px;
        }

        .dial-tick.major {
            height: 6px;
            width: 2px;
            background: #4a5568;
        }

        .warning-panel {
            margin-bottom: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            border-left: 4px solid rgb(245, 158, 11);
            background: rgba(245, 158, 11, 0.08);
        }

        .warning-panel.severe {
            border-left-color: rgb(220, 38, 38);
            background: rgba(220, 38, 38, 0.08);
        }

        .warning-title {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 1.05em;
        }

        .warning-item {
            padding: 4px 0;
            font-size: 0.95em;
        }

        .warning-icon {
            margin-right: 4px;
        }

        .warning-icon.high {
            color: rgb(220, 38, 38);
        }

        .warning-icon.medium {
            color: rgb(245, 158, 11);
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .main-content {
                padding: 15px;
            }

            header {
                padding: 20px 15px;
            }

            h1 {
                font-size: 1.8em;
            }

            .subtitle {
                font-size: 1em;
            }

            .controls-row {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                padding: 15px;
            }

            .config-title {
                font-size: 1.1em;
                padding: 8px 12px;
            }

            .button-row {
                flex-direction: column;
            }

            button {
                padding: 12px;
                font-size: 1em;
            }

            .legend {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 15px;
            }

            .chart-container {
                padding: 15px;
                margin-bottom: 15px;
                box-shadow: 2px 0 4px rgba(102, 126, 234, 0.2) inset;
            }

            .warning-panel {
                padding: 12px 15px;
                font-size: 0.9em;
            }

            .warning-title {
                font-size: 1em;
            }

            table {
                font-size: 0.9em;
            }

            th, td {
                padding: 10px 8px;
            }

            /* Make table scrollable on mobile */
            .data-table {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Ensure dial touch targets are adequate */
            .dial-container {
                width: 70px;
                height: 70px;
            }

            .dial-group label {
                font-size: 0.9em;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .main-content {
                padding: 10px;
            }

            header {
                padding: 15px 10px;
            }

            h1 {
                font-size: 1.5em;
                margin-bottom: 5px;
            }

            .subtitle {
                font-size: 0.9em;
            }

            .controls-row {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 12px;
            }

            .config-title {
                font-size: 1em;
                padding: 8px 10px;
            }

            .control-group label,
            .dial-group label {
                font-size: 0.85em;
                margin-bottom: 6px;
            }

            .control-group select {
                padding: 8px;
                font-size: 0.95em;
            }

            button {
                padding: 10px;
                font-size: 0.95em;
            }

            .legend {
                padding: 12px;
                gap: 8px;
            }

            .legend-item {
                font-size: 0.85em;
            }

            .chart-container {
                padding: 10px;
                margin-bottom: 10px;
            }

            .warning-panel {
                padding: 10px 12px;
                font-size: 0.85em;
            }

            .warning-item {
                font-size: 0.85em;
            }

            table {
                font-size: 0.85em;
            }

            th {
                padding: 8px 6px;
                font-size: 0.8em;
            }

            td {
                padding: 8px 6px;
            }

            /* Reduce dial size slightly on very small screens */
            .dial-container {
                width: 65px;
                height: 65px;
            }
        }

        /* Landscape phone orientation */
        @media (max-width: 768px) and (orientation: landscape) {
            .controls-row {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 480px) and (orientation: landscape) {
            .controls-row {
                grid-template-columns: repeat(2, 1fr);
            }

            h1 {
                font-size: 1.3em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Keihin CR26 Carburetor Tuning</h1>
            <p class="subtitle">Fuel Delivery Analysis</p>
        </header>

        <div class="main-content">
            <div class="config-section">
                <h3 class="config-title current-title">Current Configuration</h3>
                <div class="controls-row">
                    <div class="dial-group">
                        <label>Air Screw</label>
                        <div class="dial-container" id="currentAirScrewDial" data-value="1.5">
                            <div class="dial-ticks"></div>
                            <div class="dial-knob current"></div>
                            <div class="dial-value">1½</div>
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="currentPilotJet">Slow Jet</label>
                        <select id="currentPilotJet">
                            <option value="35">35</option>
                            <option value="38">38</option>
                            <option value="40">40</option>
                            <option value="42">42</option>
                            <option value="45">45</option>
                            <option value="48">48</option>
                            <option value="50">50</option>
                            <option value="52">52</option>
                            <option value="55">55</option>
                            <option value="58">58</option>
                            <option value="60">60</option>
                            <option value="62">62</option>
                            <option value="65" selected>65</option>
                            <option value="68">68</option>
                            <option value="70">70</option>
                            <option value="72">72</option>
                            <option value="75">75</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="currentSlideCutaway">Cutaway</label>
                        <select id="currentSlideCutaway">
                            <option value="1.0">1.0</option>
                            <option value="1.5">1.5</option>
                            <option value="2.0" selected>2.0</option>
                            <option value="2.5">2.5</option>
                            <option value="3.0">3.0</option>
                            <option value="3.5">3.5</option>
                            <option value="4.0">4.0</option>
                            <option value="4.5">4.5</option>
                            <option value="5.0">5.0</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="currentNeedle">Needle</label>
                        <select id="currentNeedle">
                            <optgroup label="YY Series (longer)">
                                <option value="YY5">YY5 (Rich)</option>
                                <option value="YY6">YY6</option>
                                <option value="YY7">YY7</option>
                                <option value="YY8" selected>YY8</option>
                                <option value="YY9">YY9</option>
                                <option value="YY0">YY0 (CR26 std)</option>
                                <option value="YY1">YY1</option>
                                <option value="YY2">YY2</option>
                                <option value="YY3">YY3 (Lean)</option>
                            </optgroup>
                            <optgroup label="Y Series (shorter)">
                                <option value="Y5">Y5 (Rich)</option>
                                <option value="Y6">Y6</option>
                                <option value="Y7">Y7</option>
                                <option value="Y8">Y8</option>
                                <option value="Y9">Y9</option>
                                <option value="Y0">Y0</option>
                                <option value="Y1">Y1</option>
                                <option value="Y2">Y2</option>
                                <option value="Y3">Y3 (Lean)</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="currentMAJ">Air Jet</label>
                        <select id="currentMAJ">
                            <option value="150">150</option>
                            <option value="160">160</option>
                            <option value="170">170</option>
                            <option value="180">180</option>
                            <option value="190">190</option>
                            <option value="200">200</option>
                            <option value="210">210</option>
                            <option value="220" selected>220</option>
                            <option value="230">230</option>
                            <option value="240">240</option>
                            <option value="250">250</option>
                            <option value="260">260</option>
                            <option value="270">270</option>
                            <option value="280">280</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="currentMainJet">Main Jet</label>
                        <select id="currentMainJet">
                            <option value="80">80</option>
                            <option value="85">85</option>
                            <option value="90">90</option>
                            <option value="95">95</option>
                            <option value="100">100</option>
                            <option value="105" selected>105</option>
                            <option value="110">110</option>
                            <option value="115">115</option>
                            <option value="120">120</option>
                            <option value="125">125</option>
                            <option value="130">130</option>
                            <option value="135">135</option>
                            <option value="140">140</option>
                            <option value="145">145</option>
                            <option value="150">150</option>
                            <option value="155">155</option>
                            <option value="160">160</option>
                            <option value="165">165</option>
                            <option value="170">170</option>
                            <option value="175">175</option>
                            <option value="180">180</option>
                            <option value="185">185</option>
                            <option value="190">190</option>
                            <option value="195">195</option>
                            <option value="200">200</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="config-section">
                <h3 class="config-title correction-title">Correction</h3>
                <div class="controls-row correction-row">
                    <div class="dial-group">
                        <label>Air Screw</label>
                        <div class="dial-container" id="correctionAirScrewDial" data-value="1.5">
                            <div class="dial-ticks"></div>
                            <div class="dial-knob correction"></div>
                            <div class="dial-value">1½</div>
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="correctionPilotJet">Slow Jet</label>
                        <select id="correctionPilotJet">
                            <option value="35">35</option>
                            <option value="38">38</option>
                            <option value="40">40</option>
                            <option value="42">42</option>
                            <option value="45">45</option>
                            <option value="48">48</option>
                            <option value="50">50</option>
                            <option value="52">52</option>
                            <option value="55">55</option>
                            <option value="58">58</option>
                            <option value="60">60</option>
                            <option value="62">62</option>
                            <option value="65" selected>65</option>
                            <option value="68">68</option>
                            <option value="70">70</option>
                            <option value="72">72</option>
                            <option value="75">75</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="correctionSlideCutaway">Cutaway</label>
                        <select id="correctionSlideCutaway">
                            <option value="1.0">1.0</option>
                            <option value="1.5">1.5</option>
                            <option value="2.0" selected>2.0</option>
                            <option value="2.5">2.5</option>
                            <option value="3.0">3.0</option>
                            <option value="3.5">3.5</option>
                            <option value="4.0">4.0</option>
                            <option value="4.5">4.5</option>
                            <option value="5.0">5.0</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="correctionNeedle">Needle</label>
                        <select id="correctionNeedle">
                            <optgroup label="YY Series (longer)">
                                <option value="YY5">YY5 (Rich)</option>
                                <option value="YY6">YY6</option>
                                <option value="YY7">YY7</option>
                                <option value="YY8" selected>YY8</option>
                                <option value="YY9">YY9</option>
                                <option value="YY0">YY0 (CR26 std)</option>
                                <option value="YY1">YY1</option>
                                <option value="YY2">YY2</option>
                                <option value="YY3">YY3 (Lean)</option>
                            </optgroup>
                            <optgroup label="Y Series (shorter)">
                                <option value="Y5">Y5 (Rich)</option>
                                <option value="Y6">Y6</option>
                                <option value="Y7">Y7</option>
                                <option value="Y8">Y8</option>
                                <option value="Y9">Y9</option>
                                <option value="Y0">Y0</option>
                                <option value="Y1">Y1</option>
                                <option value="Y2">Y2</option>
                                <option value="Y3">Y3 (Lean)</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="correctionMAJ">Air Jet</label>
                        <select id="correctionMAJ">
                            <option value="150">150</option>
                            <option value="160">160</option>
                            <option value="170">170</option>
                            <option value="180">180</option>
                            <option value="190">190</option>
                            <option value="200">200</option>
                            <option value="210">210</option>
                            <option value="220" selected>220</option>
                            <option value="230">230</option>
                            <option value="240">240</option>
                            <option value="250">250</option>
                            <option value="260">260</option>
                            <option value="270">270</option>
                            <option value="280">280</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="correctionMainJet">Main Jet</label>
                        <select id="correctionMainJet">
                            <option value="80">80</option>
                            <option value="85">85</option>
                            <option value="90">90</option>
                            <option value="95">95</option>
                            <option value="100">100</option>
                            <option value="105" selected>105</option>
                            <option value="110">110</option>
                            <option value="115">115</option>
                            <option value="120">120</option>
                            <option value="125">125</option>
                            <option value="130">130</option>
                            <option value="135">135</option>
                            <option value="140">140</option>
                            <option value="145">145</option>
                            <option value="150">150</option>
                            <option value="155">155</option>
                            <option value="160">160</option>
                            <option value="165">165</option>
                            <option value="170">170</option>
                            <option value="175">175</option>
                            <option value="180">180</option>
                            <option value="185">185</option>
                            <option value="190">190</option>
                            <option value="195">195</option>
                            <option value="200">200</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="button-row">
                <button onclick="copyCurrentToCorrection()">Copy Current → Correction</button>
            </div>

            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Throttle Position</th>
                            <th>Current Fuel</th>
                            <th>Correction Fuel</th>
                            <th>Difference</th>
                            <th>Primary Component</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                    </tbody>
                </table>
            </div>

            <div id="warningPanel" class="warning-panel" style="display: none;"></div>

            <div class="chart-container">
                <canvas id="flowChart"></canvas>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-line" style="background: rgb(59, 130, 246);"></div>
                    <span id="currentClipLabel">Current (clip 4)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line" style="background: rgb(34, 197, 94);"></div>
                    <span id="correctionClipLabel">Correction (clip 4)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-band" style="background: rgb(59, 130, 246);"></div>
                    <span id="currentBandLabel">Current clip range (1-7)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-band" style="background: rgb(34, 197, 94);"></div>
                    <span id="correctionBandLabel">Correction clip range (1-7)</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Throttle positions
        const THROTTLE_POSITIONS = [
            { label: 'Idle', value: 0 },
            { label: '1/4 Throttle', value: 25 },
            { label: '1/2 Throttle', value: 50 },
            { label: '3/4 Throttle', value: 75 },
            { label: 'WOT', value: 100 }
        ];

        // CR26 stock jetting specs (from Keihin manual)
        const BASELINE = {
            mainJet: 105,
            pilotJet: 65,      // "Slow Jet" in manual
            slideCutaway: 2.0, // "Throttle Valve" in manual
            mainAirJet: 220,   // "Air Jet" in manual
            needle: 'YY0',     // CR26 stock needle
            needleClip: 4
        };

        const FLAT_SPOT_DIP_THRESHOLD = 0.03;    // 3% valley depth
        const FLAT_SPOT_GRADIENT_THRESHOLD = 0.003; // gradient discontinuity

        // Keihin CR Special needle profiles
        // Diameter (D) determines richness: smaller D = more fuel flow = richer
        // YY series is 2.7mm longer than Y series (same diameters)
        // Fuel factor (for D) calculated relative to YY0 (CR26 stock, D=2.805)
        // Taper angles are identical within Y/YY series (0°50', 3°30', 1°30')
        // Y series has shorter taper segments, sitting shallower in needle jet → ~4% less fuel in taper zone (50-75% throttle)
        // YY series: 7 clip positions; Y series: 5 clip positions
        const NEEDLES = {
            // YY Series (longer, 7 clips)
            'YY5': { name: 'YY5', d: 2.755, fuel: 1.10, taper: 1.00, clips: 7 },  // Richest
            'YY6': { name: 'YY6', d: 2.765, fuel: 1.08, taper: 1.00, clips: 7 },
            'YY7': { name: 'YY7', d: 2.775, fuel: 1.06, taper: 1.00, clips: 7 },
            'YY8': { name: 'YY8', d: 2.785, fuel: 1.04, taper: 1.00, clips: 7 },
            'YY9': { name: 'YY9', d: 2.795, fuel: 1.02, taper: 1.00, clips: 7 },
            'YY0': { name: 'YY0', d: 2.805, fuel: 1.00, taper: 1.00, clips: 7 },  // CR26 stock
            'YY1': { name: 'YY1', d: 2.815, fuel: 0.98, taper: 1.00, clips: 7 },
            'YY2': { name: 'YY2', d: 2.825, fuel: 0.96, taper: 1.00, clips: 7 },
            'YY3': { name: 'YY3', d: 2.835, fuel: 0.94, taper: 1.00, clips: 7 },  // Leanest
            // Y Series (shorter, 5 clips)
            'Y5':  { name: 'Y5',  d: 2.755, fuel: 1.10, taper: 0.96, clips: 5 },
            'Y6':  { name: 'Y6',  d: 2.765, fuel: 1.08, taper: 0.96, clips: 5 },
            'Y7':  { name: 'Y7',  d: 2.775, fuel: 1.06, taper: 0.96, clips: 5 },
            'Y8':  { name: 'Y8',  d: 2.785, fuel: 1.04, taper: 0.96, clips: 5 },
            'Y9':  { name: 'Y9',  d: 2.795, fuel: 1.02, taper: 0.96, clips: 5 },
            'Y0':  { name: 'Y0',  d: 2.805, fuel: 1.00, taper: 0.96, clips: 5 },
            'Y1':  { name: 'Y1',  d: 2.815, fuel: 0.98, taper: 0.96, clips: 5 },
            'Y2':  { name: 'Y2',  d: 2.825, fuel: 0.96, taper: 0.96, clips: 5 },
            'Y3':  { name: 'Y3',  d: 2.835, fuel: 0.94, taper: 0.96, clips: 5 }
        };

        let chart;

        // Influence weighting functions
        function pilotWeight(throttle) {
            // Strong at idle, fades by ~30%
            return Math.exp(-throttle / 12);
        }

        function airScrewWeight(throttle) {
            // Air screw affects 0-12% throttle (idle zone), same decay as pilot jet
            return Math.exp(-throttle / 12);
        }

        function cutawayWeight(throttle) {
            // Bell curve centered at 20%, width 15
            return Math.exp(-Math.pow(throttle - 20, 2) / (2 * 15 * 15));
        }

        // Needle D (diameter): affects 1/8-1/4 throttle (12-25%)
        function needleDWeight(throttle) {
            return Math.exp(-Math.pow(throttle - 18, 2) / (2 * 10 * 10));
        }

        // Needle Clip/L1: affects 1/4-1/2 throttle (25-50%)
        function needleClipWeight(throttle) {
            return Math.exp(-Math.pow(throttle - 37, 2) / (2 * 15 * 15));
        }

        // Needle Taper: affects 1/2-3/4 throttle (50-75%)
        function needleTaperWeight(throttle) {
            return Math.exp(-Math.pow(throttle - 62, 2) / (2 * 15 * 15));
        }

        function mainWeight(throttle) {
            // Smooth step from 60 to 100
            if (throttle <= 60) return 0;
            if (throttle >= 100) return 1;
            const t = (throttle - 60) / 40;
            return t * t * (3 - 2 * t); // smoothstep
        }

        function majWeight(throttle) {
            // Smooth step from 70 to 100
            if (throttle <= 70) return 0;
            if (throttle >= 100) return 1;
            const t = (throttle - 70) / 30;
            return t * t * (3 - 2 * t); // smoothstep
        }

        // Calculate relative fuel delivery at a given throttle position
        // Returns a value where 1.0 = baseline fuel delivery
        function calculateFuel(throttle, mainJet, pilotJet, slideCutaway, mainAirJet, needle, needleClip, airScrew = 1.5) {
            // Base fuel curve - increases with throttle opening
            const baseFuel = 0.2 + (throttle / 100) * 0.8;

            // Calculate flow ratios using diameter² relationship
            // Larger jet = more fuel flow (area ∝ diameter²)
            const pilotFlowRatio = Math.pow(pilotJet / BASELINE.pilotJet, 2);
            const mainFlowRatio = Math.pow(mainJet / BASELINE.mainJet, 2);

            // Slide cutaway: larger = more air = less relative fuel
            const cutawayEffect = 1 - (slideCutaway - BASELINE.slideCutaway) * 0.08;

            // Main Air Jet: larger = more air bleed into fuel circuit = less fuel
            const majEffect = 1 - (mainAirJet - BASELINE.mainAirJet) / BASELINE.mainAirJet * 0.3;

            // Air Screw effect: It's an AIR bleed screw
            // Clockwise (fewer turns) = richer (less air bleed)
            // Counter-clockwise (more turns) = leaner (more air bleed)
            // Baseline at 1.5 turns = 1.0 (neutral)
            // 0.5 turns = 1.06 (6% richer), 3.0 turns = 0.91 (9% leaner)
            const airScrewEffect = 1.0 - (airScrew - 1.5) * 0.06;

            // Needle profile data
            const needleData = NEEDLES[needle] || NEEDLES['YY0'];

            // Needle clip effect: 1 = highest (richest), max clip = lowest (leanest)
            // Each clip position changes fuel by ~3-5%
            const midClip = Math.ceil(needleData.clips / 2);
            const needleClipEffect = 1 + (midClip - needleClip) * 0.04;

            // Apply weighted influence based on throttle position
            const pW = pilotWeight(throttle);
            const asW = airScrewWeight(throttle);
            const cW = cutawayWeight(throttle);
            const dW = needleDWeight(throttle);      // Needle D: 1/8-1/4
            const clipW = needleClipWeight(throttle); // Needle clip: 1/4-1/2
            const taperW = needleTaperWeight(throttle); // Needle taper: 1/2-3/4
            const mW = mainWeight(throttle);
            const maW = majWeight(throttle);

            // Combine effects with their influence weights
            let fuelMultiplier = 1.0;

            // Pilot jet effect
            fuelMultiplier *= 1 + (pilotFlowRatio - 1) * pW;

            // Air screw effect (same zone as pilot jet)
            fuelMultiplier *= 1 + (airScrewEffect - 1) * asW;

            // Slide cutaway effect
            fuelMultiplier *= 1 + (cutawayEffect - 1) * cW;

            // Needle diameter effect (1/8-1/4 throttle)
            fuelMultiplier *= 1 + (needleData.fuel - 1) * dW;

            // Needle clip effect (1/4-1/2 throttle)
            fuelMultiplier *= 1 + (needleClipEffect - 1) * clipW;

            // Needle taper effect (1/2-3/4 throttle)
            fuelMultiplier *= 1 + (needleData.taper - 1) * taperW;

            // Main jet effect
            fuelMultiplier *= 1 + (mainFlowRatio - 1) * mW;

            // MAJ effect (reduces fuel at high throttle)
            fuelMultiplier *= 1 + (majEffect - 1) * maW;

            return baseFuel * fuelMultiplier;
        }

        // Detect flat spots and bogs in the correction curve relative to current
        function detectFlatSpots(currentConfig, correctionConfig) {
            const numPoints = 51;
            const warnings = [];
            const ratios = [];

            // Sample correction/current ratio at 2% intervals
            for (let i = 0; i < numPoints; i++) {
                const throttle = (i / (numPoints - 1)) * 100;
                const currentFuel = calculateFuel(throttle, currentConfig.mainJet, currentConfig.pilotJet, currentConfig.slideCutaway, currentConfig.maj, currentConfig.needle, currentConfig.clip, currentConfig.airScrew);
                const correctionFuel = calculateFuel(throttle, correctionConfig.mainJet, correctionConfig.pilotJet, correctionConfig.slideCutaway, correctionConfig.maj, correctionConfig.needle, correctionConfig.clip, correctionConfig.airScrew);
                ratios.push({ throttle, ratio: correctionFuel / currentFuel });
            }

            // Detect valleys (fuel dips then rises = classic bog)
            for (let i = 1; i < ratios.length - 1; i++) {
                const prev = ratios[i - 1].ratio;
                const curr = ratios[i].ratio;
                const next = ratios[i + 1].ratio;

                // Valley: current point is lower than both neighbors
                if (curr < prev && curr < next) {
                    const depth = Math.min(prev - curr, next - curr);
                    if (depth >= FLAT_SPOT_DIP_THRESHOLD) {
                        const severity = depth >= 0.06 ? 'high' : 'medium';
                        warnings.push({
                            type: 'valley',
                            severity,
                            throttleStart: ratios[Math.max(0, i - 3)].throttle,
                            throttleEnd: ratios[Math.min(ratios.length - 1, i + 3)].throttle,
                            throttleCenter: ratios[i].throttle,
                            depth,
                            label: severity === 'high' ? 'Bog Warning' : 'Flat Spot'
                        });
                    }
                }
            }

            // Detect gradient discontinuities (abrupt slope changes = stumble)
            for (let i = 2; i < ratios.length - 2; i++) {
                const gradBefore = (ratios[i].ratio - ratios[i - 2].ratio) / (ratios[i].throttle - ratios[i - 2].throttle);
                const gradAfter = (ratios[i + 2].ratio - ratios[i].ratio) / (ratios[i + 2].throttle - ratios[i].throttle);
                const gradChange = Math.abs(gradAfter - gradBefore);

                if (gradChange >= FLAT_SPOT_GRADIENT_THRESHOLD) {
                    const severity = gradChange >= 0.006 ? 'high' : 'medium';
                    // Avoid duplicating if already covered by a valley warning
                    const alreadyCovered = warnings.some(w =>
                        Math.abs(w.throttleCenter - ratios[i].throttle) < 10
                    );
                    if (!alreadyCovered) {
                        warnings.push({
                            type: 'gradient',
                            severity,
                            throttleStart: ratios[Math.max(0, i - 3)].throttle,
                            throttleEnd: ratios[Math.min(ratios.length - 1, i + 3)].throttle,
                            throttleCenter: ratios[i].throttle,
                            depth: gradChange,
                            label: severity === 'high' ? 'Bog Warning' : 'Flat Spot'
                        });
                    }
                }
            }

            return mergeWarnings(warnings);
        }

        // Consolidate overlapping throttle ranges
        function mergeWarnings(warnings) {
            if (warnings.length <= 1) return warnings;

            warnings.sort((a, b) => a.throttleStart - b.throttleStart);
            const merged = [warnings[0]];

            for (let i = 1; i < warnings.length; i++) {
                const last = merged[merged.length - 1];
                if (warnings[i].throttleStart <= last.throttleEnd + 5) {
                    last.throttleEnd = Math.max(last.throttleEnd, warnings[i].throttleEnd);
                    if (warnings[i].severity === 'high') last.severity = 'high';
                    if (warnings[i].depth > last.depth) last.depth = warnings[i].depth;
                    last.label = last.severity === 'high' ? 'Bog Warning' : 'Flat Spot';
                } else {
                    merged.push(warnings[i]);
                }
            }

            return merged;
        }

        // Map warnings to Chart.js annotation plugin box configs
        function buildAnnotations(warnings) {
            const annotations = {};
            const labels = THROTTLE_POSITIONS.map(p => p.label);

            warnings.forEach((w, i) => {
                const isHigh = w.severity === 'high';

                // Map throttle % to chart x-axis position (0-4 for 5 labels)
                const xMin = (w.throttleStart / 100) * (labels.length - 1);
                const xMax = (w.throttleEnd / 100) * (labels.length - 1);

                annotations[`flatspot${i}`] = {
                    type: 'box',
                    xMin: xMin,
                    xMax: xMax,
                    backgroundColor: isHigh ? 'rgba(220, 38, 38, 0.15)' : 'rgba(245, 158, 11, 0.15)',
                    borderColor: isHigh ? 'rgba(220, 38, 38, 0.6)' : 'rgba(245, 158, 11, 0.6)',
                    borderWidth: 1,
                    borderDash: [5, 3],
                    label: {
                        display: true,
                        content: w.label,
                        position: 'start',
                        font: { size: 11, weight: 'bold' },
                        color: isHigh ? 'rgb(220, 38, 38)' : 'rgb(180, 120, 0)'
                    }
                };
            });

            return annotations;
        }

        // Update warning panel HTML
        function renderWarnings(warnings) {
            const panel = document.getElementById('warningPanel');
            if (!warnings.length) {
                panel.style.display = 'none';
                return;
            }

            panel.style.display = 'block';
            const hasSevere = warnings.some(w => w.severity === 'high');
            panel.className = 'warning-panel' + (hasSevere ? ' severe' : '');

            const items = warnings.map(w => {
                const pctStart = Math.round(w.throttleStart);
                const pctEnd = Math.round(w.throttleEnd);
                const icon = w.severity === 'high' ? '⚠' : '●';
                const typeLabel = w.type === 'valley' ? 'fuel dip (bog)' : 'abrupt transition (stumble)';
                return `<div class="warning-item"><span class="warning-icon ${w.severity}">${icon}</span> <strong>${w.label}</strong> at ${pctStart}–${pctEnd}% throttle — ${typeLabel}</div>`;
            }).join('');

            panel.innerHTML = `<div class="warning-title">${hasSevere ? 'Bog/Flat-Spot Detected' : 'Potential Flat Spots'}</div>${items}`;
        }

        // Get primary component affecting this throttle position
        // Based on chart from Keihin CR-Special manual (page 4)
        function getPrimaryComponent(throttle) {
            if (throttle <= 12) return 'Air Screw, Slow Jet';
            if (throttle <= 25) return 'Cutaway, Needle D';
            if (throttle <= 50) return 'Needle Clip/L1';
            if (throttle <= 75) return 'Needle Taper';
            return 'Main Jet, Air Jet';
        }

        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('flowChart').getContext('2d');

            Chart.register(ChartDataLabels);

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: THROTTLE_POSITIONS.map(p => p.label),
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label && !context.dataset.label.includes('Band')) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}`;
                                    }
                                    return null;
                                }
                            }
                        },
                        datalabels: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            title: {
                                display: true,
                                text: 'Throttle Position',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        y: {
                            position: 'left',
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            title: {
                                display: true,
                                text: 'Relative Fuel Delivery',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            min: 0
                        }
                    }
                }
            });
        }

        // Update chart and table
        function updateVisualization() {
            // Current configuration
            const currentMainJet = parseFloat(document.getElementById('currentMainJet').value);
            const currentPilotJet = parseFloat(document.getElementById('currentPilotJet').value);
            const currentSlideCutaway = parseFloat(document.getElementById('currentSlideCutaway').value);
            const currentNeedle = document.getElementById('currentNeedle').value;
            const currentMAJ = parseFloat(document.getElementById('currentMAJ').value);
            const currentAirScrew = parseFloat(document.getElementById('currentAirScrewDial').dataset.value);

            // Correction configuration
            const correctionMainJet = parseFloat(document.getElementById('correctionMainJet').value);
            const correctionPilotJet = parseFloat(document.getElementById('correctionPilotJet').value);
            const correctionSlideCutaway = parseFloat(document.getElementById('correctionSlideCutaway').value);
            const correctionNeedle = document.getElementById('correctionNeedle').value;
            const correctionMAJ = parseFloat(document.getElementById('correctionMAJ').value);
            const correctionAirScrew = parseFloat(document.getElementById('correctionAirScrewDial').dataset.value);

            // Get needle data for clip counts
            const currentNeedleData = NEEDLES[currentNeedle] || NEEDLES['YY0'];
            const correctionNeedleData = NEEDLES[correctionNeedle] || NEEDLES['YY0'];
            const currentMidClip = Math.ceil(currentNeedleData.clips / 2);
            const correctionMidClip = Math.ceil(correctionNeedleData.clips / 2);

            // Calculate fuel at middle clip position for main lines
            const currentFuels = THROTTLE_POSITIONS.map(p =>
                calculateFuel(p.value, currentMainJet, currentPilotJet, currentSlideCutaway, currentMAJ, currentNeedle, currentMidClip, currentAirScrew)
            );
            const correctionFuels = THROTTLE_POSITIONS.map(p =>
                calculateFuel(p.value, correctionMainJet, correctionPilotJet, correctionSlideCutaway, correctionMAJ, correctionNeedle, correctionMidClip, correctionAirScrew)
            );

            // Detect flat spots in correction curve
            const currentConfig = {
                mainJet: currentMainJet, pilotJet: currentPilotJet,
                slideCutaway: currentSlideCutaway, maj: currentMAJ,
                needle: currentNeedle, clip: currentMidClip, airScrew: currentAirScrew
            };
            const correctionConfig = {
                mainJet: correctionMainJet, pilotJet: correctionPilotJet,
                slideCutaway: correctionSlideCutaway, maj: correctionMAJ,
                needle: correctionNeedle, clip: correctionMidClip, airScrew: correctionAirScrew
            };
            const warnings = detectFlatSpots(currentConfig, correctionConfig);
            const annotations = buildAnnotations(warnings);
            renderWarnings(warnings);

            // Calculate needle band ranges (clip 1 = richest, max clip = leanest)
            const currentClip1 = THROTTLE_POSITIONS.map(p =>
                calculateFuel(p.value, currentMainJet, currentPilotJet, currentSlideCutaway, currentMAJ, currentNeedle, 1, currentAirScrew)
            );
            const currentClipMax = THROTTLE_POSITIONS.map(p =>
                calculateFuel(p.value, currentMainJet, currentPilotJet, currentSlideCutaway, currentMAJ, currentNeedle, currentNeedleData.clips, currentAirScrew)
            );
            const correctionClip1 = THROTTLE_POSITIONS.map(p =>
                calculateFuel(p.value, correctionMainJet, correctionPilotJet, correctionSlideCutaway, correctionMAJ, correctionNeedle, 1, correctionAirScrew)
            );
            const correctionClipMax = THROTTLE_POSITIONS.map(p =>
                calculateFuel(p.value, correctionMainJet, correctionPilotJet, correctionSlideCutaway, correctionMAJ, correctionNeedle, correctionNeedleData.clips, correctionAirScrew)
            );

            // Update chart datasets
            chart.data.datasets = [
                // Current needle band (fill between clip 1 and clip max)
                {
                    label: 'Current Band Upper',
                    data: currentClipMax,
                    borderColor: 'rgba(59, 130, 246, 0.3)',
                    backgroundColor: 'rgba(59, 130, 246, 0.15)',
                    borderWidth: 1,
                    borderDash: [4, 4],
                    tension: 0.4,
                    fill: '+1',
                    pointRadius: 0,
                    pointHoverRadius: 0
                },
                {
                    label: 'Current Band Lower',
                    data: currentClip1,
                    borderColor: 'rgba(59, 130, 246, 0.3)',
                    backgroundColor: 'transparent',
                    borderWidth: 1,
                    borderDash: [4, 4],
                    tension: 0.4,
                    fill: false,
                    pointRadius: 0,
                    pointHoverRadius: 0
                },
                // Correction needle band
                {
                    label: 'Correction Band Upper',
                    data: correctionClipMax,
                    borderColor: 'rgba(34, 197, 94, 0.3)',
                    backgroundColor: 'rgba(34, 197, 94, 0.15)',
                    borderWidth: 1,
                    borderDash: [4, 4],
                    tension: 0.4,
                    fill: '+1',
                    pointRadius: 0,
                    pointHoverRadius: 0
                },
                {
                    label: 'Correction Band Lower',
                    data: correctionClip1,
                    borderColor: 'rgba(34, 197, 94, 0.3)',
                    backgroundColor: 'transparent',
                    borderWidth: 1,
                    borderDash: [4, 4],
                    tension: 0.4,
                    fill: false,
                    pointRadius: 0,
                    pointHoverRadius: 0
                },
                // Main lines at clip 4
                {
                    label: 'Current',
                    data: currentFuels,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: false,
                    pointRadius: 6,
                    pointHoverRadius: 8
                },
                {
                    label: 'Correction',
                    data: correctionFuels,
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: false,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }
            ];

            // Update annotations
            chart.options.plugins.annotation = { annotations };

            chart.update();

            // Update legend labels
            document.getElementById('currentClipLabel').textContent = `Current (clip ${currentMidClip})`;
            document.getElementById('correctionClipLabel').textContent = `Correction (clip ${correctionMidClip})`;
            document.getElementById('currentBandLabel').textContent = `Current clip range (1-${currentNeedleData.clips})`;
            document.getElementById('correctionBandLabel').textContent = `Correction clip range (1-${correctionNeedleData.clips})`;

            // Update table
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = '';

            THROTTLE_POSITIONS.forEach((pos, i) => {
                const currentFuel = currentFuels[i];
                const correctionFuel = correctionFuels[i];
                const diff = correctionFuel - currentFuel;
                const diffPct = currentFuel > 0 ? ((diff / currentFuel) * 100) : 0;
                const component = getPrimaryComponent(pos.value);

                const row = document.createElement('tr');
                const diffColor = diff > 0.01 ? 'color: #16a34a;' : diff < -0.01 ? 'color: #dc2626;' : '';
                const diffSign = diff > 0 ? '+' : '';
                row.innerHTML = `
                    <td><strong>${pos.label}</strong></td>
                    <td style="color: rgb(59, 130, 246);">${currentFuel.toFixed(3)}</td>
                    <td style="color: rgb(34, 197, 94);">${correctionFuel.toFixed(3)}</td>
                    <td style="${diffColor}">${diffSign}${diffPct.toFixed(1)}%</td>
                    <td>${component}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Copy current to correction
        function copyCurrentToCorrection() {
            document.getElementById('correctionMainJet').value = document.getElementById('currentMainJet').value;
            document.getElementById('correctionPilotJet').value = document.getElementById('currentPilotJet').value;
            document.getElementById('correctionSlideCutaway').value = document.getElementById('currentSlideCutaway').value;
            document.getElementById('correctionNeedle').value = document.getElementById('currentNeedle').value;
            document.getElementById('correctionMAJ').value = document.getElementById('currentMAJ').value;
            // Copy air screw
            const currentAirScrew = parseFloat(document.getElementById('currentAirScrewDial').dataset.value);
            setDialValue('correctionAirScrewDial', currentAirScrew);
            saveSettings();
            updateVisualization();
        }

        // LocalStorage functions
        const STORAGE_KEY = 'keihinCR26Settings';

        function saveSettings() {
            const settings = {
                current: {
                    mainJet: document.getElementById('currentMainJet').value,
                    pilotJet: document.getElementById('currentPilotJet').value,
                    slideCutaway: document.getElementById('currentSlideCutaway').value,
                    needle: document.getElementById('currentNeedle').value,
                    maj: document.getElementById('currentMAJ').value,
                    airScrew: document.getElementById('currentAirScrewDial').dataset.value
                },
                correction: {
                    mainJet: document.getElementById('correctionMainJet').value,
                    pilotJet: document.getElementById('correctionPilotJet').value,
                    slideCutaway: document.getElementById('correctionSlideCutaway').value,
                    needle: document.getElementById('correctionNeedle').value,
                    maj: document.getElementById('correctionMAJ').value,
                    airScrew: document.getElementById('correctionAirScrewDial').dataset.value
                }
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return;

            try {
                const settings = JSON.parse(saved);
                if (settings.current) {
                    document.getElementById('currentMainJet').value = settings.current.mainJet;
                    document.getElementById('currentPilotJet').value = settings.current.pilotJet;
                    document.getElementById('currentSlideCutaway').value = settings.current.slideCutaway;
                    document.getElementById('currentNeedle').value = settings.current.needle;
                    document.getElementById('currentMAJ').value = settings.current.maj;
                    if (settings.current.airScrew) {
                        setDialValue('currentAirScrewDial', parseFloat(settings.current.airScrew));
                    }
                }
                if (settings.correction) {
                    document.getElementById('correctionMainJet').value = settings.correction.mainJet;
                    document.getElementById('correctionPilotJet').value = settings.correction.pilotJet;
                    document.getElementById('correctionSlideCutaway').value = settings.correction.slideCutaway;
                    document.getElementById('correctionNeedle').value = settings.correction.needle;
                    document.getElementById('correctionMAJ').value = settings.correction.maj;
                    if (settings.correction.airScrew) {
                        setDialValue('correctionAirScrewDial', parseFloat(settings.correction.airScrew));
                    }
                }
            } catch (e) {
                console.warn('Failed to load settings:', e);
            }
        }

        function onSettingChange() {
            saveSettings();
            updateVisualization();
        }

        // Air Screw Dial Functions
        const AIR_SCREW_MIN = 0.5;
        const AIR_SCREW_MAX = 3.0;
        const AIR_SCREW_STEP = 0.25;

        // Convert turns value to rotation angle (degrees)
        // CCW rotation like real carb: 0.5 turns = +135deg, 3.0 turns = -135deg
        function turnsToAngle(turns) {
            const normalized = (turns - AIR_SCREW_MIN) / (AIR_SCREW_MAX - AIR_SCREW_MIN);
            return 135 - normalized * 270;
        }

        // Convert rotation angle to turns value (CCW = more turns)
        function angleToTurns(angle) {
            const normalized = (135 - angle) / 270;
            let turns = AIR_SCREW_MIN + normalized * (AIR_SCREW_MAX - AIR_SCREW_MIN);
            // Snap to step
            turns = Math.round(turns / AIR_SCREW_STEP) * AIR_SCREW_STEP;
            // Clamp to range
            turns = Math.max(AIR_SCREW_MIN, Math.min(AIR_SCREW_MAX, turns));
            return turns;
        }

        // Format value as fraction (e.g., 1.5 -> "1 1/2", 0.75 -> "3/4")
        function formatAsFraction(value) {
            const whole = Math.floor(value);
            const frac = value - whole;

            let fracStr = '';
            if (Math.abs(frac - 0.25) < 0.01) fracStr = '¼';
            else if (Math.abs(frac - 0.5) < 0.01) fracStr = '½';
            else if (Math.abs(frac - 0.75) < 0.01) fracStr = '¾';

            if (whole === 0) {
                return fracStr || '0';
            } else if (fracStr) {
                return `${whole}${fracStr}`;
            } else {
                return `${whole}`;
            }
        }

        // Set dial value and update visual
        function setDialValue(dialId, value) {
            const container = document.getElementById(dialId);
            const knob = container.querySelector('.dial-knob');
            const valueDisplay = container.querySelector('.dial-value');

            container.dataset.value = value;
            knob.style.transform = `rotate(${turnsToAngle(value)}deg)`;
            valueDisplay.textContent = formatAsFraction(value);
        }

        // Initialize dial interaction
        function initDial(dialId) {
            const container = document.getElementById(dialId);
            const knob = container.querySelector('.dial-knob');
            const ticksContainer = container.querySelector('.dial-ticks');

            // Create tick marks
            const numTicks = (AIR_SCREW_MAX - AIR_SCREW_MIN) / AIR_SCREW_STEP;
            for (let i = 0; i <= numTicks; i++) {
                const tick = document.createElement('div');
                tick.className = 'dial-tick' + (i % 4 === 0 ? ' major' : '');
                const turns = AIR_SCREW_MIN + i * AIR_SCREW_STEP;
                tick.style.transform = `translateX(-50%) rotate(${turnsToAngle(turns)}deg)`;
                ticksContainer.appendChild(tick);
            }

            // Set initial position
            const initialValue = parseFloat(container.dataset.value) || 1.5;
            setDialValue(dialId, initialValue);

            let isDragging = false;
            let startAngle = 0;
            let startValue = 0;

            function getAngleFromEvent(e, rect) {
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return Math.atan2(clientY - centerY, clientX - centerX) * (180 / Math.PI) + 90;
            }

            function handleStart(e) {
                e.preventDefault();
                isDragging = true;
                const rect = container.getBoundingClientRect();
                startAngle = getAngleFromEvent(e, rect);
                startValue = parseFloat(container.dataset.value);
                knob.style.cursor = 'grabbing';
            }

            function handleMove(e) {
                if (!isDragging) return;
                e.preventDefault();

                const rect = container.getBoundingClientRect();
                const currentAngle = getAngleFromEvent(e, rect);
                let deltaAngle = currentAngle - startAngle;

                // Handle wrap-around
                if (deltaAngle > 180) deltaAngle -= 360;
                if (deltaAngle < -180) deltaAngle += 360;

                // Convert delta to turns change (negative because CCW = more turns)
                const deltaTurns = -deltaAngle / 270 * (AIR_SCREW_MAX - AIR_SCREW_MIN);
                let newValue = startValue + deltaTurns;

                // Clamp to range (before snapping to prevent overshoot)
                newValue = Math.max(AIR_SCREW_MIN, Math.min(AIR_SCREW_MAX, newValue));

                // If at limits, reset the start point to prevent accumulation
                if (newValue === AIR_SCREW_MIN || newValue === AIR_SCREW_MAX) {
                    startAngle = currentAngle;
                    startValue = newValue;
                }

                // Snap to step
                newValue = Math.round(newValue / AIR_SCREW_STEP) * AIR_SCREW_STEP;

                setDialValue(dialId, newValue);
            }

            function handleEnd() {
                if (!isDragging) return;
                isDragging = false;
                knob.style.cursor = 'grab';
                onSettingChange();
            }

            // Mouse events
            knob.addEventListener('mousedown', handleStart);
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('mouseup', handleEnd);

            // Touch events
            knob.addEventListener('touchstart', handleStart, { passive: false });
            document.addEventListener('touchmove', handleMove, { passive: false });
            document.addEventListener('touchend', handleEnd);

            // Scroll wheel event with accumulator for slower response
            let scrollAccum = 0;
            const SCROLL_THRESHOLD = 150; // pixels of scroll needed per step
            container.addEventListener('wheel', function(e) {
                e.preventDefault();
                scrollAccum += e.deltaY;

                if (Math.abs(scrollAccum) >= SCROLL_THRESHOLD) {
                    const currentValue = parseFloat(container.dataset.value);
                    // Scroll up = CCW = more turns, scroll down = CW = fewer turns
                    const delta = scrollAccum > 0 ? -AIR_SCREW_STEP : AIR_SCREW_STEP;
                    let newValue = currentValue + delta;
                    newValue = Math.max(AIR_SCREW_MIN, Math.min(AIR_SCREW_MAX, newValue));
                    setDialValue(dialId, newValue);
                    onSettingChange();
                    scrollAccum = 0;
                }
            }, { passive: false });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize air screw dials
            initDial('currentAirScrewDial');
            initDial('correctionAirScrewDial');

            loadSettings();
            initChart();
            updateVisualization();

            // Add event listeners for current configuration
            document.getElementById('currentMainJet').addEventListener('change', onSettingChange);
            document.getElementById('currentPilotJet').addEventListener('change', onSettingChange);
            document.getElementById('currentSlideCutaway').addEventListener('change', onSettingChange);
            document.getElementById('currentNeedle').addEventListener('change', onSettingChange);
            document.getElementById('currentMAJ').addEventListener('change', onSettingChange);

            // Add event listeners for correction configuration
            document.getElementById('correctionMainJet').addEventListener('change', onSettingChange);
            document.getElementById('correctionPilotJet').addEventListener('change', onSettingChange);
            document.getElementById('correctionSlideCutaway').addEventListener('change', onSettingChange);
            document.getElementById('correctionNeedle').addEventListener('change', onSettingChange);
            document.getElementById('correctionMAJ').addEventListener('change', onSettingChange);

        });
    </script>
</body>
</html>
